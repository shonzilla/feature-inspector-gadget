<?xml version="1.0" encoding="UTF-8"?>
<Module>
  <ModulePrefs
    title="Feature Inspector Gadget"
    author_email="shone@europe.com"
    description="Gadget for inspecting available gadget features within a gadget container"
    height="500">
    
    <!-- 
      Standard gadget features
      according to Apache Shindig OpenSocial container 
    -->
    <Optional feature="analytics" />
    <!-- Probably undetectable
    <Optional feature="auth-refresh" />
    -->
    <!-- Destroys other functionalities
    <Optional feature="caja" />
    -->
    <Optional feature="content-rewrite">
      <Param name="expires">86400</Param>
      <Param name="include-url">.jpg</Param>
      <Param name="exclude-url">.png</Param>
    </Optional>
    <Optional feature="core" />
    <Optional feature="core.io" />
    <Optional feature="dynamic-height" />
    <Optional feature="dynamic-height.util" />
    <Optional feature="flash" />
    <Optional feature="i18n" />
    <!-- Probably undetectable
    <Optional feature="locked-domain" />
    -->
    <Optional feature="minimessage" />
    <Optional feature="oauthpopup" />
    <Optional feature="opensocial-0.6" />
    <Optional feature="opensocial-0.7" />
    <Optional feature="opensocial-0.8" />
    <Optional feature="opensocial-0.9" />
    <Optional feature="opensocial-base" />
    <!-- Probably undetectable
    <Optional feature="opensocial-current" />
    -->
    <Optional feature="opensocial-data" />
    <Optional feature="opensocial-data-context" />
    <Optional feature="opensocial-jsonrpc" />
    <Optional feature="opensocial-reference" />
    <Optional feature="opensocial-templates" />
    <Optional feature="osapi" />
    <Optional feature="pubsub" />
    <Optional feature="rpc" />
    <Optional feature="setprefs" />
    <Optional feature="settitle" />
    <Optional feature="skins" />
    <Optional feature="swfobject" />
    <Optional feature="tabs" />
    <Optional feature="views" />
    <Optional feature="xmlutil" />
    
    <!-- 
      Container-specific gadget features
      OSDE doesn't support them. 
    -->
    <Optional feature="ads" />
    <Optional feature="atlassian.util" />
    <Optional feature="drag" />
    <Optional feature="finance" />
    <Optional feature="google.blog" /><!-- http://code.google.com/apis/blogger/docs/gadgets/gadgets_for_blogger.html -->
    <Optional feature="google.sharedstate" />
    <Optional feature="grid" />
    <Optional feature="multisize" />
    <Optional feature="sharedmap" /><!-- http://code.google.com/apis/maps/documentation/mapplets/basics.html -->
    <Optional feature="wave" />
    <Optional feature="xing-ext" />
    <!--
    TODO:
    check
      - http://www.socialtext.net/open/index.cgi?socialtext_specific_container_features
    -->

  </ModulePrefs>
  <Content type="html"><![CDATA[
  <style type="text/css">
    body {
      font-size: 11px;
      font-family: Verdana, Arial, sans-serif;
    }
    table .supported {
      background-color: green;
    }
    table .unsupported {
      background-color: red;
    }
    table .supported,
    table .unsupported {
      width: 20%;
      text-align: center;
      text-transform: uppercase;
      color: #fff;
      font-size: 9px;
    }
    table .name {
      width: 80%;
    }
    #unchecked-features,
    #custom-features {
      margin: 25px 0 0 0;
    }
    #unchecked-features {
      color: #999;
      margin-bottom: 10px;
    }
    .content-rewrite-test {
      display: none;
    }
  </style>

  <div id="standard-features">
    <h2>Standard Features</h2>
    <table width="100%" id="standard-features-table" border="1" cellpadding="3" cellspacing="3"></table>
  </div>
  <div id="custom-features">
    <h2>Custom Features</h2>
    <table width="100%" id="custom-features-table" border="1" cellpadding="3" cellspacing="3"></table>
  </div>
  
  <div id="unchecked-features">
    <strong>Please note:</strong> This inspector isn't (yet) able to check for the
      <i>caja</i>,
      <i>opensocial-current</i>,
      <i>locked-domain</i> and the
      <i>auth-refresh</i> feature.
  </div>
  
  <div class="content-rewrite-test">
    <img src="http://www.foo.bar/image.jpg" id="cr-jpg" />
    <img src="http://www.foo.bar/image.png" id="cr-png" />
  </div>

  <script type="text/javascript">
    var GadgetFeatureInspector = {
      _features: {
        "analytics":                  function() { return  window.urchinTracker || !!window._gat || !!window._IG_GA || !!window._IG_Analytics; },
        // "auth-refresh":            function() { return false; }, // Probably undetectable
        // "caja":                       function() { return !!window.caja___; }, // TODO
        "content-rewrite":            function() { return document.getElementById("cr-jpg").src != "http://www.foo.bar/image.jpg" && document.getElementById("cr-png").src == "http://www.foo.bar/image.png"; },
        "core":                       function() { return !!window.gadgets; },
        "core.io":                    function() { return !!window.gadgets && !!gadgets.io; },
        "dynamic-height":             function() { return ( !!window.gadgets && !!gadgets.window && !!gadgets.window.adjustHeight ) || !!window._IG_AdjustIFrameHeight; },
        "dynamic-height.util":        function() { return !!window.gadgets && !!gadgets.window && !!gadgets.window.getViewportDimensions; },
        "flash":                      function() { return ( !!window.gadgets && !!gadgets.flash ) || !!window._IG_EmbedFlash; },
        "i18n":                       function() { return !!window.gadgets && !!gadgets.i18n; },
        // "locked-domain":           function() { return false; }, // Propably undetectable
        "minimessage":                function() { return ( !!window.gadgets && !!gadgets.MiniMessage ) || !!window._IG_MiniMessage; },
        "oauthpopup":                 function() { return !!window.gadgets && !!gadgets.oauth && !!gadgets.oauth.Popup; },
        "opensocial-0.6":             function() { return !!window.opensocial && !!opensocial.Environment && !!opensocial.Environment.prototype && !!opensocial.Environment.prototype.getSurface; },
        "opensocial-0.7":             function() { return !!window.opensocial && !!opensocial.DataRequest && !!opensocial.DataRequest.Group; },
        "opensocial-0.8":             function() { return !!window.opensocial && !!opensocial.IdSpec && !!opensocial.IdSpec.GroupId; },
        "opensocial-0.9":             function() { return !!window.opensocial && !!opensocial.Person && !!opensocial.Person.prototype && !!opensocial.Person.prototype.getAppData; },
        "opensocial-base":            function() { return !!window.FieldTranslations; }, // TODO... not sure if this is correct for all OSO versions
        // "opensocial-current":         function() { return !!window.requiredConfig; }, // TODO
        "opensocial-data":            function() { return !!window.opensocial && !!opensocial.data; },
        "opensocial-data-context":    function() { return !!window.opensocial && !!opensocial.data && !!opensocial.data.DataContext; },
        "opensocial-jsonrpc":         function() { return !!window.JsonRpcContainer; },
        "opensocial-reference":       function() { return !!window.opensocial && !!opensocial.getEnvironment; },
        "opensocial-templates":       function() { return ( !!window.opensocial && !!opensocial.template || !!window.os ); },
        "osapi":                      function() { return !!window.osapi; },
        "pubsub":                     function() { return !!window.gadgets && !!gadgets.pubsub; },
        "rpc":                        function() { return !!window.gadgets && !!gadgets.rpc; },
        "setprefs":                   function() { return ( !!window.gadgets && !!gadgets.Prefs && !!gadgets.Prefs.prototype && !!gadgets.Prefs.prototype.set ) || ( !!window._IG_Prefs && !!_IG_Prefs.prototype && !!_IG_Prefs.prototype.set ); },
        "settitle":                   function() { return ( !!window.gadgets && !!gadgets.window && !!gadgets.window.setTitle ) || !!window._IG_SetTitle; },
        "skins":                      function() { return !!window.gadgets && !!gadgets.skins; },
        "swfobject":                  function() { return !!window.swfobject; },
        "tabs":                       function() { return ( !!window.gadgets && !!gadgets.Tab ) || !!window._IG_Tabs; },
        "views":                      function() { return !!window.gadgets && !!gadgets.views; },
        "xmlutil":                    function() { return !!window.opensocial && !!opensocial.xmlutil; }
      },


      _customFeatures: {
        "ads":                        function() { return !!window._ADS_ClickDestinationUrl; },
        "atlassian.util":             function() { return !!window.atlassian && !!atlassian.util; },
        "drag":                       function() { return !!window._IG_Drag; },
        "finance":                    function() { return !!window.google && !!google.finance; },
        "google.blog":                function() { return !!window.google && !!google.Blog; },
        "google.sharedstate":         function() { return !!window.gadgets && !!gadgets.sharedstate; },
        "grid":                       function() { return !!window._IG_Grid; },
        "multisize":                  function() { return !!window._IG_MultiSize; },
        "sharedmap":                  function() { return !!window.GMap2; },
        "wave":                       function() { return !!window.wave; },
        "xing-ext":                   function() { return !!window.xing; }
      },
      
      initialize: function() {
        var standardFeaturesTable = document.getElementById("standard-features-table"),
            customFeaturesTable = document.getElementById("custom-features-table"),
            i, isFeatureSupported, html = "", state;
        
        for (i in this._features) {
          if (this._features.hasOwnProperty(i)) {
            isFeatureSupported = this._features[i]();
            state = isFeatureSupported ? "supported" : "unsupported";
            html += '<tr><td class="name">' + i + '</td><td class="' + state + '">' + state + '</td>';
          }
        }
        standardFeaturesTable.innerHTML = html;
        
        html = ""
        for (i in this._customFeatures) {
          if (this._customFeatures.hasOwnProperty(i)) {
            isFeatureSupported = this._customFeatures[i]();
            state = isFeatureSupported ? "supported" : "unsupported";
            html += '<tr><td class="name">' + i + '</td><td class="' + state + '">' + state + '</td>';
          }
        }
        customFeaturesTable.innerHTML = html;
        
        this._adjustHeight();
      },

      _adjustHeight: function() {
        try {
          gadgets.window.adjustHeight();
        } catch(e) {
          try { window._IG_AdjustIFrameHeight(); } catch(e) {}
        };
      }
    };


    var initializer = function() { GadgetFeatureInspector.initialize(); };

    if (window._IG_RegisterOnloadHandler) {
      window._IG_RegisterOnloadHandler(initializer);
    } else if (window.gadgets && gadgets.util && gadgets.util.registerOnLoadHandler) {
      gadgets.util.registerOnLoadHandler(initializer);
    } else {
      initializer();
    }
  </script>
  ]]></Content>
</Module>